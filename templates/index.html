<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Flipkart Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- ===============================================================
         BOOTSTRAP & ICONS
         =============================================================== -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
      integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
      crossorigin="anonymous"
    />

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>

  <body>
    <!-- ===============================================================
         BACKGROUND OVERLAY (see style.css for background image)
         =============================================================== -->
    <div class="bg-overlay"></div>

    <!-- ===============================================================
         MAIN CONTAINER — responsive Bootstrap layout
         =============================================================== -->
    <div class="container-fluid h-100">
      <div class="row justify-content-center align-items-center h-100 px-2">
        <div class="col-12 col-lg-10 col-xl-9 chat">
          <!-- Chat Card -->
          <div class="card chat-card shadow-lg">

            <!-- ========================= HEADER ======================= -->
            <div class="card-header msg_head">
              <div class="d-flex bd-highlight align-items-center">
                <div class="img_cont">
                  <img
                    src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png"
                    class="rounded-circle user_img"
                    alt="Bot"
                  />
                  <span class="online_icon"></span>
                </div>
                <div class="user_info">
                  <span class="chat-title">Flipkart Chatbot</span>
                  <p class="chat-subtitle">Ask me anything!</p>
                </div>
              </div>
            </div>

            <!-- ===================== MESSAGE BODY ===================== -->
            <div id="messageFormeight" class="card-body msg_card_body">
              <!-- Dynamic chat messages appended here -->
            </div>

            <!-- ========================= FOOTER ======================= -->
            <div class="card-footer">
              <form id="messageArea" class="input-group">
                <input
                  type="text"
                  id="text"
                  name="msg"
                  placeholder="Type your message…"
                  autocomplete="off"
                  class="form-control type_msg"
                  required
                />
                <div class="input-group-append">
                  <button type="submit" id="send" class="input-group-text send_btn">
                    <i class="fas fa-location-arrow"></i>
                  </button>
                </div>
              </form>
            </div>
          </div>
          <!-- End Chat Card -->
        </div>
      </div>
    </div>

    <!-- ===============================================================
         JS LIBRARIES
         =============================================================== -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"
    ></script>

    <!-- ===============================================================
         MAIN CHAT SCRIPT — Handles form submission and auto-scroll
         =============================================================== -->
    <script>
      // Pads time values (e.g. 8 -> "08")
      const pad = (n) => (n < 10 ? "0" + n : "" + n);

      // Scroll chat body to the latest message
      function scrollToBottom() {
        const box = document.getElementById("messageFormeight");
        if (box) box.scrollTop = box.scrollHeight;
      }

      $(document).ready(function () {
        $("#messageArea").on("submit", function (event) {
          event.preventDefault();

          const now = new Date();
          const str_time = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
          const rawText = $("#text").val().trim();
          if (!rawText) return;

          // Append user message bubble
          const userHtml =
            '<div class="d-flex justify-content-end mb-4">' +
            '<div class="msg_cotainer_send">' +
            $("<div>").text(rawText).html() +
            '<span class="msg_time_send">' +
            str_time +
            "</span></div>" +
            '<div class="img_cont_msg">' +
            '<img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" class="rounded-circle user_img_msg" alt="You">' +
            "</div></div>";

          $("#text").val("");
          $("#messageFormeight").append(userHtml);
          scrollToBottom();

          // Send to Flask backend
          $.ajax({
            data: { msg: rawText },
            type: "POST",
            url: "/get",
          })
            .done(function (data) {
              const reply =
                typeof data === "string"
                  ? data
                  : data.answer || JSON.stringify(data);

              // Append bot reply bubble
              const botHtml =
                '<div class="d-flex justify-content-start mb-4">' +
                '<div class="img_cont_msg">' +
                '<img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" class="rounded-circle user_img_msg" alt="Bot">' +
                "</div>" +
                '<div class="msg_cotainer">' +
                $("<div>").text(reply).html().replace(/\n/g, "<br>") +
                '<span class="msg_time">' +
                str_time +
                "</span></div></div>";

              $("#messageFormeight").append($.parseHTML(botHtml));
              scrollToBottom();
            })
            .fail(function () {
              const errHtml =
                '<div class="d-flex justify-content-start mb-4">' +
                '<div class="img_cont_msg">' +
                '<img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" class="rounded-circle user_img_msg" alt="Bot">' +
                "</div>" +
                '<div class="msg_cotainer">' +
                "Sorry—something went wrong. Please try again." +
                '<span class="msg_time">' +
                str_time +
                "</span></div></div>";
              $("#messageFormeight").append($.parseHTML(errHtml));
              scrollToBottom();
            });
        });

        // Always start scrolled to bottom
        scrollToBottom();
      });
    </script>
  </body>
</html>
